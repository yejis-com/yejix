<style>
  .links line {
    stroke: #ccc;
    opacity: 0.5;
  }

  .nodes circle {
    cursor: pointer;
    fill: #8b88e6;
    transition: all 0.15s ease-out;
  }

  .text text {
    cursor: pointer;
    fill: #333;
    text-shadow: -1px -1px 0 #fafafabb, 1px -1px 0 #fafafabb, -1px 1px 0 #fafafabb, 1px 1px 0 #fafafabb;
  }

  .nodes [active],
  .text [active] {
    cursor: pointer;
    fill: black;
  }

  .inactive {
    opacity: 0.1;
    transition: all 0.15s ease-out;
  }

  #graph-wrapper {
    background: transparent;
    border: none;
    height: 100%;
    width: 100%;
  }
  
  #graph-wrapper > svg {
    max-width: 100%;
    display: block;
  }
</style>

<div id="graph-wrapper">
  <div id="notes-graph">
    <script>
      const MINIMAL_NODE_SIZE = 8;
      const MAX_NODE_SIZE = 12;
      const ACTIVE_RADIUS_FACTOR = 1.5;
      const STROKE = 1;
      const FONT_SIZE = 16;
      const TICKS = 200;
      const FONT_BASELINE = 40;
      const MAX_LABEL_LENGTH = 50;

      // JSON 데이터 로드
      const graphData = {
        "nodes": [
          {"id": "example1", "url": "/example1", "backlinks": []},
          {"id": "example2", "url": "/example2", "backlinks": [{"id": "example1"}]},
          {"id": "example3", "url": "/example3", "backlinks": [{"id": "example1"}, {"id": "example2"}]}
        ],
        "edges": [
          {"source": "example1", "target": "example2", "weight": 1},
          {"source": "example1", "target": "example3", "weight": 1},
          {"source": "example2", "target": "example3", "weight": 1}
        ]
      };
      
      let nodesData = graphData.nodes;
      let linksData = graphData.edges;

      const nodeSize = {};

      const updateNodeSize = () => {
        nodesData.forEach((el) => {
          let weight = 1;
          if (el.backlinks) {
            weight = Math.sqrt((el.backlinks.length || 0) + 1);
          }
          nodeSize[el.id] = weight;
        });
      };

      const initializeDisplay = () => {
        updateNodeSize();

        const container = document.getElementById('notes-graph');
        const containerRect = container.getBoundingClientRect();
        const width = containerRect.width;
        const height = containerRect.height;

        const color = (d) => {
          return '#8b88e6';
        };

        const drag = simulation => {
          function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }
          
          function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
          }
          
          function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }
          
          return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
        };

        const height_factor = 1;

        const simulation = d3.forceSimulation(nodesData)
          .force("link", d3.forceLink(linksData).id(d => d.id).distance(d => 40))
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("x", d3.forceX(width / 2))
          .force("y", d3.forceY(height / 2));

        const svg = d3.select('#notes-graph')
          .append('svg')
          .attr("width", width)
          .attr("height", height)
          .attr("viewBox", [0, 0, width, height]);

        const link = svg.append("g")
          .attr("stroke", "#999")
          .attr("stroke-opacity", 0.6)
          .selectAll("line")
          .data(linksData)
          .join("line")
          .attr("stroke-width", d => Math.sqrt(d.weight) * STROKE)
          .attr("class", "link");

        const node = svg.append("g")
          .attr("stroke", "#fff")
          .attr("stroke-width", 2)
          .selectAll("circle")
          .data(nodesData)
          .join("circle")
          .attr("r", d => (Math.sqrt(nodeSize[d.id]) || 1) * 3)
          .attr("fill", color)
          .attr("class", "node")
          .call(drag(simulation));

        node.append("title")
          .text(d => d.id);

        const labels = svg.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("fill", "#fff")
          .selectAll("text")
          .data(nodesData)
          .join("text")
          .attr("class", "label")
          .attr("stroke", "none")
          .attr("opacity", 0.7)
          .attr("dx", 12)
          .attr("dy", ".35em")
          .text(d => shorten(d.id, MAX_LABEL_LENGTH));

        node.on("mouseover", function(event, d) {
          const currentNode = d3.select(this);
          currentNode.attr("r", d => (Math.sqrt(nodeSize[d.id]) || 1) * 3 * ACTIVE_RADIUS_FACTOR);

          d3.select(this.parentNode)
            .selectAll("circle")
            .filter(function(d2) {
              return isConnected(d, d2);
            })
            .attr("r", d => (Math.sqrt(nodeSize[d.id]) || 1) * 3 * ACTIVE_RADIUS_FACTOR);

          link.filter(function(d2) {
            return d2.source.id === d.id || d2.target.id === d.id;
          }).attr("stroke-opacity", 1);

          labels.filter(function(d2) {
            return isConnected(d, d2);
          }).attr("opacity", 1);
        });

        node.on("mouseout", function(event, d) {
          const currentNode = d3.select(this);
          currentNode.attr("r", d => (Math.sqrt(nodeSize[d.id]) || 1) * 3);
          
          d3.select(this.parentNode)
            .selectAll("circle")
            .filter(function(d2) {
              return isConnected(d, d2);
            })
            .attr("r", d => (Math.sqrt(nodeSize[d.id]) || 1) * 3);

          link.filter(function(d2) {
            return d2.source.id === d.id || d2.target.id === d.id;
          }).attr("stroke-opacity", 0.6);

          labels.filter(function(d2) {
            return isConnected(d, d2);
          }).attr("opacity", 0.7);
        });

        node.on("click", function(event, d) {
          window.location = d.url;
        });

        simulation.on("tick", () => {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

          node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

          labels
            .attr("x", d => d.x)
            .attr("y", d => d.y);
        });

        // 리사이징을 위한 함수
        window.graph = {
          restart: function() {
            // 컨테이너 크기 업데이트
            const containerRect = container.getBoundingClientRect();
            const newWidth = containerRect.width;
            const newHeight = containerRect.height;
            
            // SVG 크기 업데이트
            svg.attr("width", newWidth)
               .attr("height", newHeight)
               .attr("viewBox", [0, 0, newWidth, newHeight]);
            
            // 중심점 업데이트
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2))
                     .force("x", d3.forceX(newWidth / 2))
                     .force("y", d3.forceY(newHeight / 2))
                     .alpha(0.3)
                     .restart();
          }
        };

        function isConnected(a, b) {
          return a.id === b.id || 
            linksData.some(d => (d.source.id === a.id && d.target.id === b.id) || (d.source.id === b.id && d.target.id === a.id));
        }

        function isCurrentPath(notePath) {
          return window.location.pathname.includes(notePath);
        }

        function shorten(str, maxLen, separator = ' ') {
          if (str.length <= maxLen) return str;
          return str.substr(0, str.lastIndexOf(separator, maxLen)) + '...';
        }
      }

      // 페이지 로드 시 그래프 초기화
      if (typeof d3 !== 'undefined') {
        initializeDisplay();
      } else {
        // D3가 로드되지 않은 경우 로드 후 초기화
        document.addEventListener('DOMContentLoaded', function() {
          if (typeof d3 !== 'undefined') {
            initializeDisplay();
          }
        });
      }
    </script>
  </div>
</div>
